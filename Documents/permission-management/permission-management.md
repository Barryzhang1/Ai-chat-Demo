# 权限管理系统需求文档

## 1. 系统概述

### 1.1 项目背景
为商家后台系统添加权限管理功能，实现对用户角色的管理和控制，确保不同角色的用户具有相应的操作权限。

### 1.2 项目目标
- 提供用户列表查看功能
- 支持修改用户角色权限
- 建立基于角色的权限控制体系

### 1.3 适用范围
- 商家后台管理系统
- 需要权限控制的业务场景

## 2. 架构设计

### 2.1 系统架构
```
┌─────────────────┐
│   ChatUI        │
│  (前端界面)      │
└────────┬────────┘
         │ HTTP/REST
         │
┌────────▼────────┐
│  ChatBackEnd    │
│  (后端API)      │
└────────┬────────┘
         │
┌────────▼────────┐
│   MongoDB       │
│  (数据存储)      │
└─────────────────┘
```

### 2.2 技术栈
- **后端**：NestJS + TypeScript + MongoDB
- **前端**：React + TypeScript + Material-UI
- **认证**：JWT Token

## 3. 功能特性

### 3.1 角色定义
系统定义三种用户角色：

| 角色 | 英文标识 | 权限说明 |
|------|---------|---------|
| 老板 | BOSS | 最高权限，可管理所有功能 |
| 员工 | STAFF | 基本操作权限，可处理订单等日常业务 |
| 用户 | USER | 普通用户权限，仅能查看和下单 |

### 3.2 功能列表

#### 3.2.1 用户列表展示
- **功能描述**：展示系统中所有已注册用户
- **展示信息**：
  - 用户ID
  - 用户名
  - 当前角色
  - 注册时间
  - 操作按钮

#### 3.2.2 角色修改
- **功能描述**：修改指定用户的角色权限
- **操作方式**：下拉选择框
- **角色选项**：老板/员工/用户
- **权限控制**：只有老板角色可以修改其他用户角色

## 4. 技术实现

### 4.1 后端实现

#### 4.1.1 数据模型
```typescript
// User Schema 扩展
{
  username: string;
  password: string;
  role: 'BOSS' | 'STAFF' | 'USER';  // 新增角色字段
  createdAt: Date;
  updatedAt: Date;
}
```

#### 4.1.2 API接口设计
详见第5节 API接口文档

#### 4.1.3 权限验证
- 使用装饰器实现角色权限验证
- JWT Token中包含用户角色信息
- 中间件拦截未授权请求

### 4.2 前端实现

#### 4.2.1 页面结构
```
商家后台
  └── 权限管理 (Permission Management)
       └── 用户列表页面
            ├── 用户表格
            ├── 角色选择器
            └── 操作按钮
```

#### 4.2.2 组件设计
- `PermissionManagement.tsx` - 主页面组件
- `UserTable.tsx` - 用户列表表格
- `RoleSelector.tsx` - 角色选择组件

## 5. API 接口文档

### 5.1 获取所有用户列表

**接口地址**：`GET /api/users/list`

**请求头**：
```json
{
  "Authorization": "Bearer {token}"
}
```

**请求参数**：无

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "username": "admin",
      "role": "BOSS",
      "createdAt": "2026-01-20T10:00:00.000Z",
      "updatedAt": "2026-01-20T10:00:00.000Z"
    }
  ]
}
```

### 5.2 更新用户角色

**接口地址**：`PATCH /api/users/:userId/role`

**请求头**：
```json
{
  "Authorization": "Bearer {token}"
}
```

**请求参数**：
```json
{
  "role": "STAFF"
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "用户角色更新成功",
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "username": "employee01",
    "role": "STAFF",
    "updatedAt": "2026-01-30T15:30:00.000Z"
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "权限不足，只有老板可以修改用户角色"
}
```

## 6. 数据模型

### 6.1 User 模型

```typescript
interface User {
  _id: ObjectId;
  username: string;
  password: string;
  role: UserRole;
  createdAt: Date;
  updatedAt: Date;
}

enum UserRole {
  BOSS = 'BOSS',
  STAFF = 'STAFF',
  USER = 'USER'
}
```

## 7. 使用指南

### 7.1 访问权限管理
1. 使用老板账号登录商家后台
2. 点击左侧导航栏的"权限管理"菜单
3. 进入用户列表页面

### 7.2 修改用户角色
1. 在用户列表中找到目标用户
2. 点击"角色"列的下拉选择框
3. 选择新的角色（老板/员工/用户）
4. 系统自动保存并提示修改成功

### 7.3 权限说明
- 只有老板角色可以访问权限管理页面
- 只有老板角色可以修改其他用户的角色
- 员工和用户角色无权访问此功能

## 8. 安全考虑

### 8.1 权限验证
- 所有API请求必须携带有效的JWT Token
- 后端严格验证用户角色权限
- 防止普通用户越权操作

### 8.2 数据安全
- 用户密码不在列表中展示
- 敏感操作记录日志
- 防止SQL注入和XSS攻击

## 9. 后续扩展

### 9.1 功能扩展
- 添加更细粒度的权限控制（资源级别）
- 支持自定义角色
- 添加权限变更日志
- 批量修改用户角色

### 9.2 性能优化
- 用户列表分页加载
- 角色信息缓存
- 搜索和筛选功能
