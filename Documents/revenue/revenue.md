# 收入管理系统需求文档

## 1. 系统概述

收入管理系统是专为老板角色设计的财务数据分析工具，提供多维度的收入、毛利率和净利润统计，同时支持额外收支的录入和管理。系统通过分析订单数据、库存成本和额外收支，为经营决策提供数据支持。

### 1.1 核心目标
- 提供日/月/总维度的收入统计分析
- 计算准确的毛利率和净利润
- 支持额外收入支出的灵活录入
- 提供完整的收支流水查询
- 确保数据安全，只有老板可访问

### 1.2 应用场景
- 老板查看每日营业数据
- 月度经营分析和决策
- 成本控制和利润分析
- 额外收支的规范管理

## 2. 架构设计

### 2.1 系统架构
```
┌─────────────────────────────────────────┐
│          收入管理系统                    │
├─────────────────────────────────────────┤
│  前端界面层 (React + Ant Design Mobile)│
│  - 收入统计展示                          │
│  - 额外收支管理                          │
├─────────────────────────────────────────┤
│  后端API层 (NestJS)                     │
│  - 收入统计服务                          │
│  - 额外收支服务                          │
│  - 权限控制 (仅BOSS)                     │
├─────────────────────────────────────────┤
│  数据层 (MongoDB)                        │
│  - Orders 订单数据                       │
│  - PurchaseOrders 进货单数据             │
│  - InventoryLoss 损耗数据                │
│  - ExtraTransactions 额外收支数据        │
└─────────────────────────────────────────┘
```

### 2.2 数据流向
```
订单数据 ──┐
          ├──► 收入计算 ──► 毛利率 ──► 净利润
进货成本 ──┤
          ├──► 成本计算
损耗成本 ──┘
          
额外收支 ──────────► 净利润调整
```

## 3. 功能特性

### 3.1 收入统计功能

#### 3.1.1 当日数据查询
- **查询维度**：当天 00:00:00 - 23:59:59
- **统计指标**：
  - **当日收入**：所有已完成订单的总价之和
  - **当日成本**：对应菜品的原材料成本（进货价 × 数量）+ 当日额外支出
  - **当日毛利润**：当日收入 - 原材料成本
  - **当日毛利率**：(当日毛利润 / 当日收入) × 100%
  - **当日净利润**：当日毛利润 - 当日额外支出 + 当日额外收入
  - **订单数量**：当日已完成订单数

#### 3.1.2 月度数据查询
- **查询维度**：指定月份的 1日 00:00:00 - 最后一天 23:59:59
- **统计指标**：
  - **月度收入**：月内所有已完成订单的总价之和
  - **月度成本**：原材料成本 + 月度额外支出
  - **月度毛利润**：月度收入 - 原材料成本
  - **月度毛利率**：(月度毛利润 / 月度收入) × 100%
  - **月度净利润**：月度毛利润 - 月度额外支出 + 月度额外收入
  - **订单数量**：月内已完成订单数

#### 3.1.3 总体数据查询
- **查询维度**：系统运行以来的所有数据
- **统计指标**：
  - **总收入**：所有已完成订单的总价之和
  - **总成本**：所有原材料成本 + 所有额外支出
  - **总毛利润**：总收入 - 原材料成本
  - **总毛利率**：(总毛利润 / 总收入) × 100%
  - **总净利润**：总毛利润 - 所有额外支出 + 所有额外收入
  - **订单数量**：所有已完成订单数

### 3.2 额外收支管理

#### 3.2.1 批量录入功能
**功能描述**：支持一次性录入多条额外收入或支出记录

**录入字段**：
- **类型** (必填)：收入(income) / 支出(expense)
- **金额** (必填)：大于 0 的数字
- **分类** (必填)：如"房租"、"水电费"、"设备维修"、"其他收入"等
- **描述** (可选)：详细说明，最多 200 字符
- **日期** (必填)：发生日期，默认当天

**操作流程**：
1. 点击"添加额外收支"按钮
2. 进入批量录入页面
3. 点击"添加一行"可添加多条记录
4. 填写每条记录的详细信息
5. 点击"批量提交"一次性保存所有记录
6. 系统验证并保存，返回列表页面

**验证规则**：
- 至少录入 1 条记录
- 每条记录字段完整
- 金额必须大于 0
- 日期不能为未来日期

#### 3.2.2 收支列表查询
**功能描述**：查看和管理所有额外收支记录

**查询条件 (UI升级)**：
- **顶部 Dropdown 筛选**：
    - **类型**：单选（全部 / 收入 / 支出）
    - **日期**：快捷选项（全部 / 今天 / 近7天 / 本月）+ 自定义范围
- **搜索栏**：
    - 独立搜索框，支持按描述内容模糊搜索
    - 支持回车触发搜索

**列表展示**：
- 日期
- 类型标签（收入/支出，不同颜色区分）
- 分类
- 金额（收入显示绿色 +，支出显示红色 -）
- 描述
- 创建人
- 创建时间
- 操作（查看详情、删除）

**统计摘要**：
- 查询结果的收入总额
- 查询结果的支出总额
- 净额（收入 - 支出）

#### 3.2.3 删除功能
**功能描述**：删除错误录入的收支记录

**权限控制**：只有老板可以删除
**删除方式**：软删除（标记 deletedAt）
**影响范围**：删除后自动重新计算相关时间段的净利润

## 4. 技术实现

### 4.1 后端实现

#### 4.1.1 数据模型

**ExtraTransaction Schema (额外收支)**
```typescript
{
  _id: ObjectId,
  transactionNo: string,      // 流水号 (格式: TXN + 时间戳 + 随机数)
  type: string,                // 类型: 'income' | 'expense'
  amount: number,              // 金额 (正数)
  category: string,            // 分类
  description?: string,        // 描述
  transactionDate: Date,       // 发生日期
  creator: string,             // 创建人ID
  createdAt: Date,            // 创建时间
  updatedAt: Date,            // 更新时间
  deletedAt?: Date            // 软删除标记
}
```

**索引设计**：
- `transactionNo`: 唯一索引
- `type`: 普通索引
- `transactionDate`: 降序索引（用于日期范围查询）
- `deletedAt`: 普通索引（用于软删除查询）
- `creator`: 普通索引

#### 4.1.2 成本计算逻辑

**原材料成本计算**：
```typescript
// 方案：使用进货单平均价格
// 由于菜品和原材料没有直接绑定关系，我们采用简化计算：
// 成本 = (当期进货总额 + 期初库存价值 - 期末库存价值 - 损耗金额)

// 对于本系统，采用更简化的方式：
// 毛利率 = 30%（预设值，可配置）
// 原材料成本 = 收入 × (1 - 毛利率)
```

**注**：由于当前系统菜品和库存原材料之间没有直接绑定关系，成本计算采用行业平均毛利率进行估算。未来可扩展为精确的成本核算系统。

#### 4.1.3 API 接口设计

**收入统计接口**：
- `GET /api/revenue/stats/today` - 获取当日统计
- `GET /api/revenue/stats/month?date=YYYY-MM` - 获取月度统计
- `GET /api/revenue/stats/total` - 获取总体统计

**额外收支接口**：
- `POST /api/revenue/transactions/batch` - 批量创建收支记录
- `GET /api/revenue/transactions` - 查询收支列表
- `GET /api/revenue/transactions/:id` - 查询收支详情
- `DELETE /api/revenue/transactions/:id` - 删除收支记录

### 4.2 前端实现

#### 4.2.1 页面结构
```
收入管理 (RevenueManagement)
├── 收入统计 (RevenueStats)
│   ├── 数据卡片（当日/月度/总计）
│   ├── 趋势图表（可选）
│   └── 明细查询
└── 额外收支 (ExtraTransactions)
    ├── 批量录入 (BatchCreate)
    ├── 列表查询 (List)
    │   ├── 顶部筛选 (Dropdown: 日期/类型)
    │   ├── 搜索栏 (SearchBar)
    │   └── 收支列表 (无限滚动)
    └── 详情查看 (Detail)
```

#### 4.2.2 路由配置
```javascript
// 在 App.js 中添加
{
  path: '/revenue',
  element: <BossOnlyRoute><RevenueManagement /></BossOnlyRoute>
}
```

#### 4.2.3 菜单配置
```javascript
// 在 MerchantDashboard.js 的菜单中添加
{
  title: '收入管理',
  icon: <MoneyCollectOutline />,
  path: '/revenue',
  badge: null,
  visible: isBoss() // 仅老板可见
}
```

## 5. API 接口文档

### 5.1 获取当日收入统计

**接口**: `GET /api/revenue/stats/today`

**权限**: 仅 BOSS

**请求参数**:
- `date` (可选): 查询日期 (YYYY-MM-DD)，默认当天

**响应格式**:
```json
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "date": "2026-02-01",
    "revenue": 3580.00,
    "cost": 2506.00,
    "grossProfit": 1074.00,
    "grossMarginRate": 30.00,
    "netProfit": 874.00,
    "orderCount": 25,
    "extraIncome": 0.00,
    "extraExpense": 200.00
  }
}
```

### 5.2 获取月度收入统计

**接口**: `GET /api/revenue/stats/month`

**权限**: 仅 BOSS

**请求参数**:
- `date` (可选): 查询月份 (YYYY-MM)，默认当月

**响应格式**:
```json
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "month": "2026-02",
    "revenue": 108500.00,
    "cost": 75950.00,
    "grossProfit": 32550.00,
    "grossMarginRate": 30.00,
    "netProfit": 26550.00,
    "orderCount": 756,
    "extraIncome": 500.00,
    "extraExpense": 6500.00
  }
}
```

### 5.3 获取总体收入统计

**接口**: `GET /api/revenue/stats/total`

**权限**: 仅 BOSS

**响应格式**:
```json
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "revenue": 526800.00,
    "cost": 368760.00,
    "grossProfit": 158040.00,
    "grossMarginRate": 30.00,
    "netProfit": 132040.00,
    "orderCount": 3580,
    "extraIncome": 2500.00,
    "extraExpense": 28500.00
  }
}
```

### 5.4 批量创建额外收支

**接口**: `POST /api/revenue/transactions/batch`

**权限**: 仅 BOSS

**请求体**:
```json
{
  "transactions": [
    {
      "type": "expense",
      "amount": 5000.00,
      "category": "房租",
      "description": "2月份店铺租金",
      "transactionDate": "2026-02-01"
    },
    {
      "type": "expense",
      "amount": 800.00,
      "category": "水电费",
      "description": "1月份水电费用",
      "transactionDate": "2026-02-01"
    }
  ]
}
```

**响应格式**:
```json
{
  "code": 0,
  "message": "批量创建成功",
  "data": {
    "successCount": 2,
    "transactions": [
      {
        "_id": "507f1f77bcf86cd799439011",
        "transactionNo": "TXN20260201001",
        "type": "expense",
        "amount": 5000.00,
        "category": "房租",
        "description": "2月份店铺租金",
        "transactionDate": "2026-02-01T00:00:00.000Z",
        "creator": "user-uuid",
        "createdAt": "2026-02-01T10:30:00.000Z"
      }
    ]
  }
}
```

### 5.5 查询额外收支列表

**接口**: `GET /api/revenue/transactions`

**权限**: 仅 BOSS

**请求参数**:
- `type` (可选): income | expense
- `category` (可选): 分类筛选
- `startDate` (可选): 开始日期 (YYYY-MM-DD)
- `endDate` (可选): 结束日期 (YYYY-MM-DD)
- `keyword` (可选): 描述关键词搜索
- `page` (可选): 页码，默认 1
- `pageSize` (可选): 每页数量，默认 20

**响应格式**:
```json
{
  "code": 0,
  "message": "查询成功",
  "data": {
    "list": [
      {
        "_id": "507f1f77bcf86cd799439011",
        "transactionNo": "TXN20260201001",
        "type": "expense",
        "amount": 5000.00,
        "category": "房租",
        "description": "2月份店铺租金",
        "transactionDate": "2026-02-01T00:00:00.000Z",
        "creator": "user-uuid",
        "createdAt": "2026-02-01T10:30:00.000Z",
        "updatedAt": "2026-02-01T10:30:00.000Z"
      }
    ],
    "summary": {
      "totalIncome": 500.00,
      "totalExpense": 12500.00,
      "netAmount": -12000.00
    },
    "total": 15,
    "page": 1,
    "pageSize": 20
  }
}
```

### 5.6 删除额外收支

**接口**: `DELETE /api/revenue/transactions/:id`

**权限**: 仅 BOSS

**响应格式**:
```json
{
  "code": 0,
  "message": "删除成功"
}
```

## 6. 数据模型

### 6.1 ExtraTransaction 模型

```typescript
interface ExtraTransaction {
  _id: ObjectId;
  transactionNo: string;       // 流水号
  type: 'income' | 'expense';  // 类型
  amount: number;              // 金额
  category: string;            // 分类
  description?: string;        // 描述
  transactionDate: Date;       // 发生日期
  creator: string;             // 创建人ID
  createdAt: Date;            // 创建时间
  updatedAt: Date;            // 更新时间
  deletedAt?: Date;           // 删除时间（软删除）
}

enum TransactionType {
  INCOME = 'income',
  EXPENSE = 'expense'
}
```

### 6.2 索引设计

- **唯一索引**: `transactionNo`
- **复合索引**: `type + transactionDate`（用于按类型和日期查询）
- **普通索引**: 
  - `deletedAt`（用于软删除过滤）
  - `creator`（用于查询创建人）

## 7. 使用指南

### 7.1 查看收入统计

1. **进入收入管理页面**
   - 使用老板账号登录
   - 点击左侧菜单"收入管理"
   - 自动显示当日、本月和总体统计

2. **查看详细数据**
   - 当日数据：实时更新，包含今天的所有已完成订单
   - 月度数据：显示本月累计数据，可切换其他月份
   - 总体数据：显示系统运行以来的所有数据

3. **数据指标说明**
   - **收入**：已完成订单的销售额
   - **成本**：原材料成本 + 额外支出
   - **毛利润**：收入 - 原材料成本
   - **毛利率**：毛利润 / 收入 × 100%
   - **净利润**：毛利润 - 额外支出 + 额外收入

### 7.2 录入额外收支

1. **批量录入**
   - 点击"添加额外收支"按钮
   - 点击"添加一行"创建新记录
   - 填写类型、金额、分类、描述和日期
   - 可添加多条记录
   - 点击"批量提交"保存所有记录

2. **常见分类示例**
   - **支出**: 房租、水电费、人工工资、设备维修、营销费用、其他支出
   - **收入**: 政府补贴、设备租赁收入、其他收入

3. **注意事项**
   - 金额必须大于 0
   - 日期不能选择未来日期
   - 描述字段可详细说明用途
   - 提交后立即影响净利润计算

### 7.3 管理收支记录

1. **查询记录**
   - 使用筛选条件快速定位记录
   - 支持按类型、分类、日期范围筛选
   - 支持关键词搜索描述内容

2. **删除记录**
   - 点击记录右侧的"删除"按钮
   - 确认删除操作
   - 系统自动更新相关统计数据

3. **统计摘要**
   - 列表底部显示查询结果的统计
   - 包含收入总额、支出总额和净额

## 8. 权限控制

### 8.1 访问权限
- **收入统计查询**: 仅 BOSS
- **额外收支录入**: 仅 BOSS
- **额外收支删除**: 仅 BOSS

### 8.2 前端权限控制
```javascript
// 路由保护
<BossOnlyRoute>
  <RevenueManagement />
</BossOnlyRoute>

// 菜单显示
visible: isBoss()
```

### 8.3 后端权限控制
```typescript
@Controller('revenue')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.BOSS)
export class RevenueController { }
```

## 9. 测试要点

### 9.1 功能测试
- ✅ 当日收入统计准确性
- ✅ 月度收入统计准确性
- ✅ 总体收入统计准确性
- ✅ 毛利率和净利润计算正确性
- ✅ 额外收支批量录入
- ✅ 收支列表查询和筛选
- ✅ 收支记录删除

### 9.2 权限测试
- ✅ BOSS 角色可以访问所有功能
- ✅ STAFF 和 USER 角色无法访问
- ✅ 菜单仅对 BOSS 可见

### 9.3 边界测试
- ✅ 无订单时统计数据为 0
- ✅ 无额外收支时净利润等于毛利润
- ✅ 日期范围边界处理
- ✅ 金额精度处理（保留 2 位小数）

### 9.4 性能测试
- ✅ 大量订单数据的统计性能
- ✅ 大量收支记录的查询性能
- ✅ 批量录入的处理能力

## 10. 未来扩展

### 10.1 精确成本核算
- 建立菜品与原材料的绑定关系
- 实现精确的成本计算
- 支持成本分析和优化

### 10.2 数据可视化
- 收入趋势图表
- 成本构成饼图
- 利润率折线图
- 收支对比柱状图

### 10.3 财务报表
- 月度损益表
- 现金流量表
- 成本分析报表
- 导出 Excel 功能

### 10.4 预算管理
- 设置月度预算
- 预算执行监控
- 超预算预警
- 预算对比分析

## 11. 注意事项

1. **数据安全**
   - 收入数据属于敏感信息，必须严格控制访问权限
   - 所有API接口必须验证用户角色为 BOSS

2. **计算准确性**
   - 金额统一保留 2 位小数
   - 百分比保留 2 位小数
   - 避免浮点数精度问题

3. **性能优化**
   - 统计查询添加合适的索引
   - 考虑缓存常用统计数据
   - 大数据量时使用聚合查询

4. **用户体验**
   - 加载时显示骨架屏
   - 错误提示友好清晰
   - 批量操作提供进度反馈
