# 菜品成本价计算功能测试用例

## 测试目标
验证菜品列表能够正确计算并显示成本价、出售价格和利润

---

## 测试用例 1：有绑定食材的菜品成本计算

### 前置条件
1. 系统中存在库存食材数据
   - 食材A：lastPrice = 10元
   - 食材B：lastPrice = 15元
2. 创建菜品"宫保鸡丁"
   - 出售价格：38元
   - 绑定食材：食材A + 食材B

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 查看"宫保鸡丁"菜品信息

### 预期结果
- 显示售价：¥38.00
- 显示成本：¥25.00 (10 + 15)
- 显示利润：¥13.00 (38 - 25)
- 利润颜色为蓝色（正利润）

---

## 测试用例 2：未绑定食材的菜品成本计算

### 前置条件
1. 创建菜品"凉拌黄瓜"
   - 出售价格：8元
   - 未绑定任何食材

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 查看"凉拌黄瓜"菜品信息

### 预期结果
- 显示售价：¥8.00
- 显示成本：¥0.00
- 显示利润：¥8.00
- 利润颜色为蓝色（正利润）

---

## 测试用例 3：绑定的食材已删除

### 前置条件
1. 系统中存在食材C：lastPrice = 20元
2. 创建菜品"红烧肉"
   - 出售价格：48元
   - 绑定食材：食材C
3. 删除食材C

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 查看"红烧肉"菜品信息
4. 检查后端日志

### 预期结果
- 显示售价：¥48.00
- 显示成本：¥0.00（因为食材已删除）
- 显示利润：¥48.00
- 后端日志显示：`食材 xxx 不存在或已删除`
- 功能不报错，正常显示

---

## 测试用例 4：亏本菜品显示

### 前置条件
1. 系统中存在食材D：lastPrice = 30元
2. 创建菜品"特价菜"
   - 出售价格：20元
   - 绑定食材：食材D

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 查看"特价菜"菜品信息

### 预期结果
- 显示售价：¥20.00
- 显示成本：¥30.00
- 显示利润：-¥10.00
- 利润颜色为红色（负利润/亏本）

---

## 测试用例 5：多个食材的成本累加

### 前置条件
1. 系统中存在多个食材：
   - 食材E：lastPrice = 5元
   - 食材F：lastPrice = 8元
   - 食材G：lastPrice = 12元
2. 创建菜品"什锦炒饭"
   - 出售价格：25元
   - 绑定食材：食材E + 食材F + 食材G

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 查看"什锦炒饭"菜品信息
4. 检查后端日志

### 预期结果
- 显示售价：¥25.00
- 显示成本：¥25.00 (5 + 8 + 12)
- 显示利润：¥0.00
- 后端日志显示详细的成本计算过程
- 前端正确显示所有价格信息

---

## 测试用例 6：搜索功能与成本价兼容性

### 前置条件
1. 系统中存在多个菜品，部分绑定食材

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 使用搜索框搜索菜品名称
4. 查看搜索结果中的成本价显示

### 预期结果
- 搜索功能正常工作
- 搜索结果中每个菜品都显示成本价
- 价格计算准确

---

## 测试用例 7：分类切换与成本价兼容性

### 前置条件
1. 系统中存在多个分类和菜品

### 执行步骤
1. 登录商家后台
2. 进入"菜品列表"页面
3. 切换不同的分类标签
4. 查看每个分类下菜品的成本价显示

### 预期结果
- 分类切换功能正常
- 每个分类下的菜品都正确显示成本价
- 价格计算准确

---

## API 测试用例

### 测试 API 响应格式

**请求**:
```bash
curl -X GET "http://localhost:3001/dish"
```

**预期响应**:
```json
[
  {
    "_id": "507f1f77bcf86cd799439011",
    "name": "宫保鸡丁",
    "price": 38,
    "categoryId": "507f191e810c19729de860ea",
    "description": "麻辣鲜香的经典川菜",
    "tags": ["热菜", "辣"],
    "ingredients": ["507f1f77bcf86cd799439012", "507f1f77bcf86cd799439013"],
    "costPrice": 25.00,
    "createdAt": "2026-02-02T10:30:00.000Z",
    "updatedAt": "2026-02-02T10:30:00.000Z"
  }
]
```

**验证点**:
- ✅ 响应中包含 `costPrice` 字段
- ✅ `costPrice` 为数字类型，保留两位小数
- ✅ 未绑定食材的菜品，`costPrice` 为 0

---

## 调试检查清单

### 后端检查
- [ ] DishModule 已导入 InventoryModule
- [ ] DishService 已注入 InventoryService
- [ ] findAll 方法正确调用 inventoryService.findOne()
- [ ] 成本价计算逻辑正确（累加所有食材价格）
- [ ] 后端日志显示详细的计算过程
- [ ] 不存在的食材不会导致整个请求失败

### 前端检查
- [ ] Inventory.js 正确显示 costPrice 字段
- [ ] 售价、成本价、利润都正确显示
- [ ] 价格保留两位小数
- [ ] 利润颜色根据正负值变化（蓝色/红色）
- [ ] 布局美观，信息清晰易读
- [ ] 未定义 costPrice 时默认显示 ¥0.00

---

## 性能测试

### 测试场景
- 100个菜品，每个绑定3-5个食材
- 检查列表加载时间

### 预期结果
- 加载时间 < 2秒
- 成本计算不影响用户体验

---

## 注意事项

1. **食材ID格式**: 确保菜品中绑定的食材ID是有效的MongoDB ObjectId
2. **错误处理**: 食材不存在时，成本价应为0，不应导致整个请求失败
3. **数据精度**: 价格保留两位小数，避免浮点数计算误差
4. **前端容错**: 即使后端未返回costPrice，前端也应显示¥0.00
5. **日志记录**: 成本计算过程应有详细日志，便于调试
