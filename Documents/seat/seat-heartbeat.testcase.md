# 座位管理心跳检测功能测试用例

## 测试概述

本测试用例用于验证座位管理模块的心跳检测机制，确保系统能够正确检测用户在线状态，并在用户长时间无响应时自动释放座位。

---

## 测试环境

- **后端服务**: ChatBackEnd (NestJS)
- **前端应用**: ChatUI (React)
- **数据库**: MongoDB + Redis
- **通信协议**: WebSocket (Socket.IO)

---

## 测试用例

### TC-001: 正常心跳响应测试

**测试目的**: 验证用户正常在线时心跳机制工作正常

**前置条件**:
- 后端服务运行正常
- 前端用户已登录
- 有可用座位

**测试步骤**:
1. 用户进入聊天页面，自动分配座位
2. 观察浏览器控制台日志
3. 等待至少30秒

**预期结果**:
- ✅ 用户成功获得座位
- ✅ 控制台每10秒收到一次 `heartbeat` 消息
- ✅ 控制台显示已发送 `heartbeatResponse` 响应
- ✅ 座位状态保持为"用餐中"
- ✅ 后端日志显示收到心跳响应

**实际结果**: [待测试]

---

### TC-002: 心跳超时释放座位测试

**测试目的**: 验证用户超过20秒无响应时座位被自动释放

**前置条件**:
- 后端服务运行正常
- 前端用户已登录并获得座位
- 有排队用户（可选）

**测试步骤**:
1. 用户进入聊天页面并获得座位
2. 在浏览器控制台执行以下代码，停止响应心跳：
   ```javascript
   socket.off('heartbeat');
   ```
3. 等待25秒
4. 观察前端页面和商家后台

**预期结果**:
- ✅ 后端在20秒后检测到超时
- ✅ 后端日志显示: `Client xxx heartbeat timeout, releasing seat...`
- ✅ 用户收到 `seatReleased` 消息，显示"由于长时间无响应，座位已被释放"
- ✅ 用户的 WebSocket 连接被断开
- ✅ 商家后台实时更新，座位变为空闲
- ✅ 如有排队用户，自动为下一位分配座位

**实际结果**: [待测试]

---

### TC-003: 座位分配时启动心跳测试

**测试目的**: 验证用户获得座位时心跳检测正确启动

**前置条件**:
- 后端服务运行正常
- 有可用座位

**测试步骤**:
1. 新用户进入聊天页面
2. 系统自动分配座位
3. 查看后端日志

**预期结果**:
- ✅ 后端日志显示: `Seat X assigned to [socketId]`
- ✅ 后端日志显示: `Heartbeat started for [socketId]`
- ✅ 10秒后后端日志显示: `Heartbeat sent to [socketId]`

**实际结果**: [待测试]

---

### TC-004: 用户主动离开时停止心跳测试

**测试目的**: 验证用户主动离开时心跳检测被正确停止

**前置条件**:
- 用户已获得座位
- 心跳检测正在运行

**测试步骤**:
1. 用户正常关闭浏览器标签页
2. 查看后端日志

**预期结果**:
- ✅ 后端日志显示: `Client disconnected: [socketId]`
- ✅ 后端日志显示: `Heartbeat stopped for [socketId]`
- ✅ 后端日志显示: `Seat X released by [socketId]`
- ✅ 商家后台实时更新座位状态

**实际结果**: [待测试]

---

### TC-005: 排队用户获得座位后启动心跳测试

**测试目的**: 验证排队用户获得座位时心跳检测正确启动

**前置条件**:
- 所有座位已满
- 用户在排队队列中
- 有座位即将释放

**测试步骤**:
1. 用户A占用所有座位
2. 用户B加入排队队列
3. 用户A释放一个座位
4. 观察用户B的状态和后端日志

**预期结果**:
- ✅ 用户B收到 `seatAssigned` 消息
- ✅ 后端日志显示: `Heartbeat started for [用户B的socketId]`
- ✅ 用户B开始接收和响应心跳消息

**实际结果**: [待测试]

---

### TC-006: 多用户同时心跳测试

**测试目的**: 验证系统能够同时为多个用户维护心跳检测

**前置条件**:
- 后端服务运行正常
- 有多个可用座位

**测试步骤**:
1. 3个用户同时进入聊天页面
2. 所有用户都获得座位
3. 观察后端日志30秒

**预期结果**:
- ✅ 所有用户都成功获得座位
- ✅ 所有用户的心跳检测都正常启动
- ✅ 每个用户每10秒收到心跳消息
- ✅ 所有用户正常响应心跳
- ✅ 座位状态都保持为"用餐中"

**实际结果**: [待测试]

---

### TC-007: 心跳超时与队列处理联动测试

**测试目的**: 验证心跳超时释放座位后，排队用户能够正确接管座位

**前置条件**:
- 所有座位已满
- 有用户在排队

**测试步骤**:
1. 用户A占用座位
2. 用户B加入排队
3. 停止用户A的心跳响应（在浏览器控制台执行 `socket.off('heartbeat')`）
4. 等待25秒
5. 观察用户B和商家后台

**预期结果**:
- ✅ 20秒后用户A的座位被释放
- ✅ 用户A的连接被断开
- ✅ 用户B自动获得该座位
- ✅ 用户B收到 `seatAssigned` 消息
- ✅ 用户B的心跳检测启动
- ✅ 商家后台实时更新，显示用户B占用座位

**实际结果**: [待测试]

---

### TC-008: 商家后台实时监控测试

**测试目的**: 验证商家后台能够实时看到心跳超时导致的座位变化

**前置条件**:
- 商家后台已打开并连接
- 有用户占用座位

**测试步骤**:
1. 打开商家后台座位管理页面
2. 用户占用座位
3. 停止用户的心跳响应
4. 观察商家后台页面

**预期结果**:
- ✅ 商家后台初始显示座位被占用
- ✅ 20秒后商家后台自动刷新
- ✅ 座位状态变为"空闲"
- ✅ "用餐中"统计数减1
- ✅ "空闲"统计数加1
- ✅ 无需手动刷新页面

**实际结果**: [待测试]

---

### TC-009: 网络抖动恢复测试

**测试目的**: 验证短暂网络中断后心跳机制能否正常恢复

**前置条件**:
- 用户已获得座位
- 心跳检测正在运行

**测试步骤**:
1. 用户获得座位并正常响应心跳
2. 在浏览器开发者工具中模拟离线（Network > Offline）
3. 等待5秒（小于20秒超时时间）
4. 恢复网络连接（Network > Online）
5. 观察心跳状态

**预期结果**:
- ✅ 网络恢复后WebSocket自动重连
- ✅ 用户重新请求座位
- ✅ 心跳检测重新启动
- ✅ 座位状态正常

**实际结果**: [待测试]

---

### TC-010: 边界条件测试 - 恰好20秒响应

**测试目的**: 验证在接近超时临界点时的行为

**前置条件**:
- 用户已获得座位

**测试步骤**:
1. 用户获得座位
2. 修改前端代码，延迟心跳响应时间为19秒
3. 观察系统行为

**预期结果**:
- ✅ 座位不会被释放（19秒 < 20秒超时）
- ✅ 心跳检测继续正常运行
- ✅ 下一次心跳检测重新开始计时

**实际结果**: [待测试]

---

## 测试工具

### 浏览器控制台调试命令

```javascript
// 停止响应心跳
socket.off('heartbeat');

// 恢复响应心跳
socket.on('heartbeat', (data) => {
  console.log('Heartbeat received:', data);
  socket.emit('heartbeatResponse', { timestamp: Date.now() });
});

// 查看当前座位信息
console.log('Seat Info:', seatInfo);

// 手动发送心跳响应
socket.emit('heartbeatResponse', { timestamp: Date.now() });
```

---

## 性能测试

### PT-001: 心跳性能测试

**测试目的**: 验证心跳机制不会对系统性能造成明显影响

**测试步骤**:
1. 模拟50个用户同时在线
2. 监控服务器CPU和内存使用率
3. 监控WebSocket连接数

**预期结果**:
- ✅ CPU使用率 < 30%
- ✅ 内存使用稳定，无内存泄漏
- ✅ 所有WebSocket连接正常
- ✅ 心跳消息延迟 < 100ms

---

## 日志验证要点

### 后端日志应包含：
```
[SeatGateway] Heartbeat started for abc123
[SeatGateway] Heartbeat sent to abc123
[SeatGateway] Heartbeat response received from abc123 at 1738051234567
[SeatGateway] Client abc123 heartbeat timeout (20150ms), releasing seat...
[SeatGateway] Seat 5 released due to heartbeat timeout
[SeatGateway] Heartbeat stopped for abc123
```

### 前端控制台应显示：
```
Heartbeat received: {timestamp: 1738051234567}
Seat released: {message: '由于长时间无响应，座位已被释放', reason: 'timeout'}
```

---

## 测试总结

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| TC-001 | [ ] | 正常心跳响应 |
| TC-002 | [ ] | 心跳超时释放座位 |
| TC-003 | [ ] | 座位分配时启动心跳 |
| TC-004 | [ ] | 用户离开停止心跳 |
| TC-005 | [ ] | 排队用户获座位启动心跳 |
| TC-006 | [ ] | 多用户同时心跳 |
| TC-007 | [ ] | 心跳超时与队列联动 |
| TC-008 | [ ] | 商家后台实时监控 |
| TC-009 | [ ] | 网络抖动恢复 |
| TC-010 | [ ] | 边界条件测试 |
| PT-001 | [ ] | 性能测试 |

---

## 已知问题

[待测试后填写]

---

## 改进建议

1. 可以考虑将心跳间隔和超时时间配置化
2. 增加心跳重试机制，防止偶发性网络问题
3. 在商家后台显示用户心跳状态指示器
4. 添加心跳统计监控面板

---

**创建日期**: 2026-01-28
**创建人**: AI Assistant
**版本**: 1.0
