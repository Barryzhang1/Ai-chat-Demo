# 随机分配分类脚本使用说明

## 功能说明

该脚本用于为数据库中的所有菜品随机分配分类。这在以下场景中特别有用：
- 批量导入新菜品后需要快速分配分类
- 测试环境下生成测试数据
- 重新随机化现有菜品的分类

## 使用方法

### 1. 前置条件

确保数据库中已经存在至少一个分类，可以通过以下方式创建分类：
- 使用商家管理后台的"类别管理"功能
- 使用分类API接口创建
- 运行分类初始化脚本

### 2. 运行脚本

在项目根目录下执行：

```bash
cd ChatBackEnd
npm run random-assign-category
```

### 3. 脚本执行流程

1. **连接数据库** - 脚本会创建NestJS应用上下文，连接到配置的MongoDB数据库
2. **获取分类** - 从数据库中读取所有可用分类
3. **获取菜品** - 读取所有菜品数据
4. **随机分配** - 为每道菜品随机选择一个分类并更新
5. **显示结果** - 显示更新成功和失败的数量

### 4. 输出示例

```
======================================
  随机分配分类脚本
======================================

📂 正在获取所有分类...
✅ 找到 6 个分类:
   1. 招牌菜
   2. 凉菜
   3. 热菜
   4. 主食
   5. 饮料
   6. 汤品

🍽️  正在获取所有菜品...
✅ 找到 50 道菜品

🔄 开始随机分配分类...
   进度: 50/50 道菜品已更新

======================================
  分配完成
======================================
✅ 成功更新: 50 道菜品
======================================
```

## 注意事项

1. **数据备份** - 该脚本会直接修改数据库中的菜品数据，建议在生产环境使用前先备份数据
2. **分类要求** - 必须至少有一个分类存在，否则脚本会退出
3. **执行时间** - 脚本执行时间取决于菜品数量，大量菜品可能需要几分钟
4. **并发安全** - 脚本会逐个更新菜品，避免并发问题

## 相关文件

- 脚本文件: `ChatBackEnd/src/scripts/random-assign-category.ts`
- 配置文件: `ChatBackEnd/package.json` (scripts.random-assign-category)
- 服务依赖: `DishService`, `CategoryService`

## 故障排除

### 错误：未找到任何分类

**原因**: 数据库中没有分类数据

**解决方法**: 
1. 登录商家管理后台，在"类别管理"中创建分类
2. 或使用API直接创建分类：
   ```bash
   curl -X POST http://localhost:3000/api/categories \
     -H "Content-Type: application/json" \
     -d '{"name":"热菜","sortOrder":1,"isActive":true}'
   ```

### 错误：更新菜品失败

**原因**: 可能是分类ID无效或数据库连接问题

**解决方法**:
1. 检查数据库连接配置
2. 确保分类数据完整且ID有效
3. 查看详细错误信息进行排查

### 脚本执行缓慢

**原因**: 菜品数量过多或数据库性能问题

**优化方法**:
1. 考虑添加批量更新功能
2. 优化数据库索引
3. 在低峰时段执行

## 版本历史

- v1.0.0 (2026-01-26) - 初始版本，支持随机分配分类功能
