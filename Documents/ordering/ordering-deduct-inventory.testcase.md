# 订单接单扣减库存功能测试用例

## 测试用例版本
- **版本号**: v1.0
- **创建日期**: 2026-02-02
- **功能描述**: 商家接单后自动扣减食材库存，并根据库存情况自动下架菜品

---

## 测试前提条件

### 数据准备
1. **菜品数据**
   - 菜品A: 宫保鸡丁 (绑定食材: 鸡肉、花生、辣椒)
   - 菜品B: 鱼香肉丝 (绑定食材: 猪肉、辣椒、木耳)
   - 菜品C: 清蒸鲈鱼 (绑定食材: 鲈鱼)
   - 菜品D: 西红柿炒鸡蛋 (未绑定食材)

2. **库存数据**
   - 鸡肉: 数量10
   - 花生: 数量5
   - 辣椒: 数量1 (临界值)
   - 猪肉: 数量8
   - 木耳: 数量10
   - 鲈鱼: 数量1 (临界值)

3. **订单数据**
   - 订单1: 包含 宫保鸡丁x1、清蒸鲈鱼x1
   - 订单2: 包含 鱼香肉丝x1
   - 订单3: 包含 西红柿炒鸡蛋x1 (无绑定食材)

---

## 测试用例清单

### TC01: 正常扣减库存场景
**测试目标**: 验证接单后正常扣减食材库存

**前置条件**:
- 订单1状态为 `pending`
- 菜品A库存充足
- 菜品C库存充足

**测试步骤**:
1. 商家调用接单API，更新订单1状态为 `confirmed`
2. 系统自动扣减订单中菜品绑定的食材库存

**预期结果**:
- 订单1状态更新为 `confirmed`
- 鸡肉库存: 10 → 9
- 花生库存: 5 → 4
- 辣椒库存: 1 → 0
- 鲈鱼库存: 1 → 0
- 操作成功返回

---

### TC02: 扣减后触发菜品自动下架
**测试目标**: 验证食材库存为0时，相关菜品自动下架

**前置条件**:
- TC01执行完成
- 辣椒库存已为0
- 鲈鱼库存已为0

**测试步骤**:
1. 查询菜品A (宫保鸡丁) 的状态
2. 查询菜品C (清蒸鲈鱼) 的状态
3. 查询菜品B (鱼香肉丝) 的状态

**预期结果**:
- 菜品A (宫保鸡丁) 的 `isDelisted` = `true` (因为辣椒库存为0)
- 菜品C (清蒸鲈鱼) 的 `isDelisted` = `true` (因为鲈鱼库存为0)
- 菜品B (鱼香肉丝) 的 `isDelisted` = `true` (因为辣椒库存为0)
- 后台日志记录下架原因

---

### TC03: 多个食材扣减场景
**测试目标**: 验证订单包含多个菜品时正确扣减所有食材

**前置条件**:
- 订单2状态为 `pending`
- 菜品B绑定3种食材

**测试步骤**:
1. 商家接单，更新订单2状态为 `confirmed`
2. 检查所有食材库存变化

**预期结果**:
- 订单2状态更新为 `confirmed`
- 猪肉库存: 8 → 7
- 辣椒库存: 已为0，保持0 (不会变成负数)
- 木耳库存: 10 → 9
- 菜品B已在TC02中下架，保持下架状态

---

### TC04: 未绑定食材的菜品
**测试目标**: 验证未绑定食材的菜品不影响库存

**前置条件**:
- 订单3状态为 `pending`
- 菜品D未绑定任何食材

**测试步骤**:
1. 商家接单，更新订单3状态为 `confirmed`
2. 检查库存变化

**预期结果**:
- 订单3状态更新为 `confirmed`
- 所有食材库存保持不变
- 操作成功完成

---

### TC05: 食材不存在或已删除
**测试目标**: 验证绑定的食材不存在时的容错处理

**前置条件**:
- 创建菜品E，绑定一个不存在的食材ID
- 创建订单4，包含菜品E

**测试步骤**:
1. 商家接单，更新订单4状态为 `confirmed`

**预期结果**:
- 订单4状态更新为 `confirmed`
- 系统跳过不存在的食材，继续处理
- 后台日志记录警告信息
- 不影响其他正常食材的扣减

---

### TC06: 库存数量为0时的扣减
**测试目标**: 验证库存已为0时不会变成负数

**前置条件**:
- 辣椒库存为0
- 创建订单5，包含需要辣椒的菜品

**测试步骤**:
1. 商家接单，更新订单5状态为 `confirmed`

**预期结果**:
- 订单5状态更新为 `confirmed`
- 辣椒库存保持为0 (不会变成-1)
- 系统记录警告日志

---

### TC07: 并发接单场景
**测试目标**: 验证多个商家同时接单的库存一致性

**前置条件**:
- 花生库存为4
- 创建订单6和订单7，都包含需要花生的菜品

**测试步骤**:
1. 两个请求同时调用接单API
2. 检查最终库存数量

**预期结果**:
- 两个订单都成功接单
- 花生库存正确扣减 (4 → 2)
- 不会出现库存计算错误

---

### TC08: 订单包含相同菜品多份
**测试目标**: 验证订单中同一菜品多份时正确计算扣减数量

**前置条件**:
- 创建订单8，包含 宫保鸡丁x3
- 鸡肉库存充足

**测试步骤**:
1. 商家接单，更新订单8状态为 `confirmed`

**预期结果**:
- 每种食材扣减数量 = 菜品数量 × 菜品份数
- 鸡肉扣减3个
- 花生扣减3个
- 辣椒扣减3个 (但库存为0，保持0)

---

## 边界条件测试

### BC01: 订单状态非pending时接单
**测试步骤**: 尝试对已完成的订单再次接单

**预期结果**: 不重复扣减库存

### BC02: 空订单
**测试步骤**: 接单时订单dishes数组为空

**预期结果**: 订单状态更新，不扣减任何库存

### BC03: 订单不存在
**测试步骤**: 使用不存在的订单ID接单

**预期结果**: 返回404错误

---

## 非功能性测试

### NF01: 性能测试
- 单次接单操作应在500ms内完成
- 批量接单(10个订单)应在3秒内完成

### NF02: 日志记录
- 记录每次库存扣减的详细信息
- 记录菜品下架的原因和时间
- 记录异常情况（食材不存在、库存为0等）

### NF03: 事务一致性
- 库存扣减和菜品下架应在同一个事务中完成
- 如果扣减失败，订单状态应回滚

---

## 测试环境要求
- 后端服务正常运行
- MongoDB数据库连接正常
- 测试数据已准备完毕

## 测试工具
- Postman / cURL (API测试)
- MongoDB Compass (数据验证)
- 后端日志查看工具

---

## 测试执行记录

| 用例编号 | 执行日期 | 执行人 | 测试结果 | 备注 |
|---------|---------|--------|---------|------|
| TC01    |         |        |         |      |
| TC02    |         |        |         |      |
| TC03    |         |        |         |      |
| TC04    |         |        |         |      |
| TC05    |         |        |         |      |
| TC06    |         |        |         |      |
| TC07    |         |        |         |      |
| TC08    |         |        |         |      |

---

## 缺陷记录
| 缺陷ID | 严重程度 | 描述 | 状态 | 修复日期 |
|--------|---------|------|------|---------|
|        |         |      |      |         |
